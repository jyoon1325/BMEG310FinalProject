---
title: "BMEG 310 Final Project"
author: "Justin Yoon, Zeena ..., Addin ..."
date: "2024-11-28"
output: html_document
---

https://github.com/jyoon1325/BMEG310FinalProject.git

Import libraries:
```{r}
#all libraries from tutorials:

#Introduction to R Basics
library(graphics)
#install.packages("ggplot2")
library(ggplot2)
#install.packages("RColorBrewer")
library(RColorBrewer)
#install.packages("rmarkdown")
library(rmarkdown)

#Introduction to Machine Learning
#install.packages("devtools")
library(devtools)
#install.packages("remotes")
#remotes::install_github("vqv/ggbiplot")
library(ggbiplot)
suppressPackageStartupMessages(library(dplyr))
#install.packages("readxl")
library(readxl)#read_excel
#install.packages("ISLR")
require(ISLR)
#install.packages("corrplot")
library(corrplot)
#install.packages("caret")
library(caret)
install.packages("randomForest")
library(randomForest)

#Introduction to Survival Analysis
#BiocManager::install("TCGAbiolinks")
library("TCGAbiolinks")
#BiocManager::install("survival")
library("survival")
#BiocManager::install("survminer")
library("survminer")
library("SummarizedExperiment")

#Introduction to Mutation Analysis
# install.packages("pheatmap")
library(pheatmap)

#Introduction to Differential Analysis
# BiocManager::install("AnnotationDbi")
# BiocManager::install("org.Hs.eg.db")
# BiocManager::install("pathview")
# BiocManager::install("gage")
# BiocManager::install("gageData")
library("gridExtra")
library(ggrepel)
library("AnnotationDbi")
library("org.Hs.eg.db")
library(pathview)
library(gage)
library(gageData)


#Additional useful libraries:
library(tidyr)
library(readr)
library(data.table)
library(stats)
library(cluster)
library(factoextra)
library(org.Hs.eg.db)
library(enrichplot)
library(DESeq2)  
#install.packages("magrittr")
library (dplyr)
library(TCGAbiolinks)
#install.packages("magrittr")

```


Import data:
```{r}
RNA.data <- read.csv("RNAseq_LIHC.csv")
patient.data <- read.table("data_clinical_patient.txt", header = TRUE, sep = "\t")
mutations.data <- read.table("data_mutations.txt", header = TRUE, sep = "\t")
```

summaries of data
```{r}
#summary(RNA.data)
#summary(patient.data)
#summary(mutations.data)
#colnames(RNA.data)
#colnames(patient.data)
#colnames(mutations.data)
```


filter data
```{r}
patient_df<-patient.data
patient_df$PATIENT_ID<-substr(patient_df$PATIENT_ID,9,12)

mutations_df<-mutations.data
mutations_df$Tumor_Sample_Barcode<-substr(mutations_df$Tumor_Sample_Barcode,9,12)

#make copy of RNA data frame without the first column
RNA_df <- RNA.data[,-1]

#rename columns to match patient id naming convention of other data sets
colnames(RNA_df)<-substr(colnames(RNA_df),9,12)

#find unique patients
unique_patients<-unique(patient_df$PATIENT_ID)
unique_mutations<-unique(mutations_df$Tumor_Sample_Barcode)
unique_RNA<-unique(colnames(RNA_df))
#find common patients
common_patients<-Reduce(intersect, list(unique_patients,unique_mutations,unique_RNA))

#patient data with patients in all three data sets
unq_patient_df<-patient_df[patient_df$PATIENT_ID %in% common_patients,]

#mutation data with patients in all three data sets
unq_mutations_df<-mutations_df[mutations_df$Tumor_Sample_Barcode %in% common_patients,]

#RNA data with patients in all three data sets
unq_RNA_ID<-RNA_df[, colnames(RNA_df)%in% common_patients]

#add back the first column (X) from the RNA data frame
RNA_df$X<-RNA.data$X[match(rownames(RNA_df), rownames(RNA.data))] 

#Take out censored patients

censored_patients <-  unq_patient_df %>%
  filter(PFS_STATUS == "0:CENSORED") %>%
  pull(PATIENT_ID)

unq_patient_df<-unq_patient_df[!unq_patient_df$PATIENT_ID %in% censored_patients,]

unq_mutations_df <-  unq_mutations_df[!unq_mutations_df$Tumor_Sample_Barcode %in% censored_patients,]

RNA_df <- RNA_df[, !colnames(RNA_df) %in% censored_patients]


unq_mutations_df$IMPACT <- as.character(unq_mutations_df$IMPACT)

#Take out Low impact mutations
filtered_mutations <- subset(unq_mutations_df, IMPACT != "LOW")


unique(filtered_mutations$IMPACT)

```
Summaries
```{r}
#summary(unq_patient_df)
summary(filtered_mutations)
#summary(unq_RNA_ID)

```





_______________________________________________________________________________________________________________________________________

Analysis:
1. Clinical Data
2. Mutation Data
3. Expression Data

_______________________________________________________________________________________________________________________________________







_______________________________________________________________________________________________________________________________________
Clinical Data:
1. Explore clinical data wrt the distribution based on various variable/attributes such as age, stage, survival, etc 
_______________________________________________________________________________________________________________________________________

Age Distribution
```{r}
ggplot(unq_patient_df, aes(x = AGE)) +
  geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Age Distribution", x = "Age", y = "Count") +
  theme_minimal()
```
cancer stage Distribution
```{r}
ggplot(unq_patient_df, aes(x = AGE, fill = OS_STATUS)) +
  geom_histogram(binwidth = 5, position = "dodge", alpha = 0.7) +
  labs(title = "Age Distribution by Overall Survival Status", x = "Age", y = "Count", fill = "Overall Survival Status") +
  theme_minimal()

```

Age vs Overall Survival
```{r}
ggplot(unq_patient_df, aes(x = AGE, fill = OS_STATUS)) +
  geom_histogram(binwidth = 5, position = "dodge", alpha = 0.7) +
  labs(title = "Age Distribution by Overall Survival", x = "Age", y = "Count", fill = "Overall Survival") +
  theme_minimal()
```
Age vs Progression-Free Survival (PFS) Status
```{r}
ggplot(unq_patient_df, aes(x = AGE, fill = PFS_STATUS)) +
  geom_histogram(binwidth = 5, position = "dodge", alpha = 0.7) +
  labs(title = "Age Distribution by Progression-Free Survival Status", x = "Age", y = "Count", fill = "Progression-Free Survival Status") +
  theme_minimal()
```
Age Distribution with Boxplot Grouped by Tumor Stage
```{r}
ggplot(unq_patient_df, aes(x = AJCC_PATHOLOGIC_TUMOR_STAGE, y = AGE, fill = AJCC_PATHOLOGIC_TUMOR_STAGE)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Age Distribution by Tumor Stage", x = "Tumor Stage", y = "Age") +
  theme_minimal() +
  theme(legend.position = "none")
```
Survival Distribution by Age
```{r}
ggplot(unq_patient_df, aes(x = AGE, fill = DSS_STATUS)) +
  geom_histogram(binwidth = 5, position = "stack", alpha = 0.7) +
  labs(title = "Age Distribution by Disease-Specific Survival Status", x = "Age", y = "Count", fill = "Disease-Specific Survival Status") +
  theme_minimal()
```

Survival analysis
Prepare Data
```{r}
#survival data
unq_patient_df <- unq_patient_df %>%
  mutate(
    #convert OS_STATUS to a logical deceased indicator
    deceased = ifelse(OS_STATUS == "1:DECEASED", TRUE, FALSE),
    #convert OS_MONTHS to numeric
    overall_survival = as.numeric(OS_MONTHS)
  )
```

Kaplan-Meier Analysis by Gender
```{r}
#fit survival model for gender
fit_gender <- survfit(Surv(overall_survival, deceased) ~ SEX, data = unq_patient_df)

#Kaplan-Meier plot for gender
ggsurvplot(fit_gender, data = unq_patient_df, pval = TRUE, risk.table = TRUE, risk.table.col = "strata", risk.table.height = 0.3)
```

Kaplan-Meier Analysis by Weight
```{r}
# categorize patients by weight
unq_patient_df <- unq_patient_df %>%
  mutate(weight_group = case_when(
    WEIGHT < 50 ~ "Underweight",
    WEIGHT >= 50 & WEIGHT < 70 ~ "Normal weight",
    WEIGHT >= 70 & WEIGHT < 90 ~ "Overweight",
    WEIGHT >= 90 ~ "Obese",
    is.na(WEIGHT) ~ "Unknown"
  ))

#exclude patients with unknown weight
unq_patient_df_filtered <- unq_patient_df %>%
  filter(weight_group != "Unknown")

#fit survival model for weight groups
fit_weight <- survfit(Surv(overall_survival, deceased) ~ weight_group, data = unq_patient_df_filtered)

#Kaplan-Meier for weight groups
ggsurvplot(fit_weight, 
           data = unq_patient_df_filtered, 
           pval = TRUE,                        # Display p-value for log-rank test
           risk.table = TRUE,                  # Add risk table below the plot
           risk.table.col = "strata",          # Color risk table by strata
           risk.table.height = 0.3,            # Adjust risk table height
           title = "Kaplan-Meier Survival Analysis by Weight Group",
           xlab = "Time (Months)", 
           ylab = "Survival Probability")

```


Kaplan-Meier Analysis by Tumor Stage
```{r}
# remove sub-stages of AJCC_PATHOLOGIC_TUMOR_STAGE
unq_patient_df <- unq_patient_df %>%
  mutate(tumor_stage = gsub("[abc]$", "", AJCC_PATHOLOGIC_TUMOR_STAGE))

#fit survival model by tumor stage
fit_stage <- survfit(Surv(overall_survival, deceased) ~ tumor_stage, data = unq_patient_df)

#Kaplan-Meier for tumor stage
ggsurvplot(fit_stage, 
           data = unq_patient_df, 
           pval = TRUE, 
           risk.table = TRUE, 
           risk.table.col = "strata", 
           risk.table.height = 0.3,
           title = "Survival by Tumor Stage")

```
Kaplan-Meier Analysis by race
```{r}
#Group races 
  #"white", "asian", "black", and "others"...?
unq_patient_df <- unq_patient_df %>%
  mutate(race_group = ifelse(RACE %in% c("white", "asian", "black or african american"), RACE, "others"))

#fit survival model by race group
fit_race <- survfit(Surv(overall_survival, deceased) ~ race_group, data = unq_patient_df)

#Kaplan-Meier plot for race
ggsurvplot(fit_race, 
           data = unq_patient_df, 
           pval = TRUE, 
           risk.table = TRUE, 
           risk.table.col = "strata", 
           risk.table.height = 0.3,
           title = "Survival by Race Group")

```
Kaplan-Meier Survival Analysis by Age Group
```{r}
# age groups
unq_patient_df <- unq_patient_df %>%
  mutate(age_group = case_when(
    AGE < 50 ~ "<50",
    AGE >= 50 & AGE < 65 ~ "50-65",
    AGE >= 65 ~ "65+"
  ))

#fit survival model by age group
fit_age <- survfit(Surv(overall_survival, deceased) ~ age_group, data = unq_patient_df)

#Kaplan-Meier
ggsurvplot(fit_age, 
           data = unq_patient_df, 
           pval = TRUE, 
           risk.table = TRUE, 
           risk.table.col = "strata", 
           risk.table.height = 0.3,
           title = "Survival by Age Group")

```






_______________________________________________________________________________________________________________________________________
Mutation data:
1. Build a gene-patient matrix that contains mutation data. Within this matrix, "1" represents whether there is a mutation in a given gene and given patient and "0" represents no mutation. Note, when building this matrix, you can take into account the type of mutations (e.g., synonymous, non-synonymous, etc) 
2. Pick the top 20 or most frequently mutated genes from this matrix.  
3. Perform clustering on the resulting mutation matrix Perhaps try ward and ward.D2 linkage methods if you see narrow clusters.
4. Take the clusters of patients and do (a) DE analysis on all genes (not just top 500), (b) do pathway analysis on the DE genes that pass the adjusted p-value threshold (not just the top 20 genes) to see if specific pathways are hit, (c) see if outcome data between patient clusters is different, (d) see if any other clinical data is different when you compare patient clusters, (e) explore the correlation between the patient clusters that you have got from mutation and expression data - how much overlap do you see between the patient clusters?
_______________________________________________________________________________________________________________________________________

1. Build a gene-patient matrix that contains mutation data. Within this matrix, "1" represents whether there is a mutation in a given gene and given patient and "0" represents no mutation. Note, when building this matrix, you can take into account the type of mutations (e.g., synonymous, non-synonymous, etc)
```{r}
# Filter the dataset for specific mutation types (e.g., nonsynonymous mutations)
filtered_mutations <- filtered_mutations[filtered_mutations$Consequence %in% 
                                         c("missense_variant", "nonsense_variant", "frameshift_variant"), ]

# Extract the relevant columns: Gene (Hugo_Symbol) and Patient (Tumor_Sample_Barcode)
gene_patient_data <- filtered_mutations[, c("Hugo_Symbol", "Tumor_Sample_Barcode")]

# Add a binary column for the presence of a mutation
gene_patient_data$mutated <- 1

# Create a wide-format matrix with genes as rows and patients as columns
gene_patient_matrix <- reshape(
  data = gene_patient_data,
  timevar = "Tumor_Sample_Barcode",
  idvar = "Hugo_Symbol",
  direction = "wide"
)

# Replace NA values with 0, indicating no mutation
gene_patient_matrix[is.na(gene_patient_matrix)] <- 0

# Clean column names to remove redundant "mutated." prefix
colnames(gene_patient_matrix) <- sub("mutated\\.", "", colnames(gene_patient_matrix))

# View the resulting matrix
head(gene_patient_matrix)
```

2. Pick the top 20 or most frequently mutated genes from this matrix.  
```{r}
# Calculate the total number of mutations for each gene (row sums)
gene_mutation_counts <- rowSums(gene_patient_matrix[, -1])  # Exclude the gene column (first column)

# Add mutation counts to the gene-patient matrix for reference
gene_patient_matrix <- cbind(Hugo_Symbol = rownames(gene_patient_matrix), gene_patient_matrix)

# Sort genes by mutation counts in descending order
sorted_genes <- gene_patient_matrix[order(-gene_mutation_counts), ]

# Select the top 20 most frequently mutated genes
top_20_genes <- sorted_genes[1:20, ]

# View the top 20 genes
print(top_20_genes)
```

3. Perform clustering on the resulting mutation matrix Perhaps try ward and ward.D2 linkage methods if you see narrow clusters.
```{r}
# Load required library
library(cluster)
library(factoextra)

# Extract the mutation matrix for the top 20 genes (removing the first column which contains gene names)
mutation_matrix_top20 <- as.matrix(top_20_genes[, -1])  # Exclude the Hugo_Symbol column

# Compute the distance matrix using Euclidean distance
distance_matrix <- dist(mutation_matrix_top20, method = "euclidean")

# Perform hierarchical clustering with ward.D method
hc_ward <- hclust(distance_matrix, method = "ward.D")

# Perform hierarchical clustering with ward.D2 method
hc_wardD2 <- hclust(distance_matrix, method = "ward.D2")

# Plot dendrograms
par(mfrow = c(1, 2))  # Arrange plots side by side

# Plot ward.D
plot(hc_ward, main = "Dendrogram (Ward.D Method)", sub = "", xlab = "Genes", ylab = "Height")

# Plot ward.D2
plot(hc_wardD2, main = "Dendrogram (Ward.D2 Method)", sub = "", xlab = "Genes", ylab = "Height")

# Use cutree to get clusters if needed (e.g., cut into 3 clusters)
clusters_ward <- cutree(hc_ward, k = 3)
clusters_wardD2 <- cutree(hc_wardD2, k = 3)

# Print cluster assignments
print("Clusters from Ward.D:")
print(clusters_ward)

print("Clusters from Ward.D2:")
print(clusters_wardD2)


```

4a. Take the clusters of patients and do (a) DE analysis on all genes (not just top 500)
count matrix:
```{r}
#gene-patient binary matrix
gene_patient_matrix <- table(filtered_mutations$Hugo_Symbol, filtered_mutations$Tumor_Sample_Barcode)

#Convert to numeric matrix
countData <- as.matrix(gene_patient_matrix)
mode(countData) <- "numeric"

```
metadata
```{r}
metadata <- data.frame(
  cluster = as.factor(clusters_ward[colnames(countData)])  # Assign cluster labels
)
rownames(metadata) <- colnames(countData)

```






_________________________________________________________________________________________________________________________________
Expression data:
1. Normalize expression data using DEseq2. This was explained and included in the lab document. 
2. Pick the top n (e.g., 500, 1000, ...) most variable genes. This could be done before step 1 or after step 1. 
3. Perform clustering on the resulting expression matrix. Perhaps try ward and ward.D2 linkage methods if you see narrow clusters.
4. Take the clusters of patients and do (a) DE analysis on all genes (not just top 500), (b) do pathway analysis on the DE genes that pass the adjusted p-value threshold (not just the top 20 genes) to see if specific pathways are hit, (c) see if outcome data between the patient clusters is different, (d) see if any other clinical data is different when you compare patient clusters, (e) see if patient clusters are enriched with any type of mutation data.   
_________________________________________________________________________________________________________________________________
```{r}

```


