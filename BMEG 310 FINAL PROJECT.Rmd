---
title: "BMEG 310 Final Project"
author: "Justin Yoon, Zeena ..., Addin ..."
date: "2024-11-28"
output: html_document
---

https://github.com/jyoon1325/BMEG310FinalProject.git

Import libraries:
```{r}
#all libraries from tutorials:

#Introduction to R Basics
library(graphics)
#install.packages("ggplot2")
library(ggplot2)
#install.packages("RColorBrewer")
library(RColorBrewer)
#install.packages("rmarkdown")
library(rmarkdown)

#Introduction to Machine Learning
#install.packages("devtools")
library(devtools)
#install.packages("remotes")
#remotes::install_github("vqv/ggbiplot")
library(ggbiplot)
suppressPackageStartupMessages(library(dplyr))
#install.packages("readxl")
library(readxl)#read_excel
#install.packages("ISLR")
require(ISLR)
#install.packages("corrplot")
library(corrplot)
#install.packages("caret")
library(caret)
install.packages("randomForest")
library(randomForest)

#Introduction to Survival Analysis
#BiocManager::install("TCGAbiolinks")
library("TCGAbiolinks")
#BiocManager::install("survival")
library("survival")
#BiocManager::install("survminer")
library("survminer")
library("SummarizedExperiment")

#Introduction to Mutation Analysis
# install.packages("pheatmap")
library(pheatmap)

#Introduction to Differential Analysis
# BiocManager::install("AnnotationDbi")
# BiocManager::install("org.Hs.eg.db")
# BiocManager::install("pathview")
# BiocManager::install("gage")
# BiocManager::install("gageData")
library("gridExtra")
library(ggrepel)
library("AnnotationDbi")
library("org.Hs.eg.db")
library(pathview)
library(gage)
library(gageData)


#Additional useful libraries:
library(tidyr)
library(readr)
library(data.table)
library(stats)
library(cluster)
library(factoextra)
library(org.Hs.eg.db)
library(enrichplot)
library(DESeq2)
library (dplyr)
library(TCGAbiolinks)




results = "hide"
```


Import data:
```{r}
RNA.data <- read.csv("RNAseq_LIHC.csv")
patient.data <- read.table("data_clinical_patient.txt", header = TRUE, sep = "\t")
mutations.data <- read.table("data_mutations.txt", header = TRUE, sep = "\t")
```

summaries of data
```{r}
#summary(RNAseq_LIHC)
#summary(data_clinical_patient)
#summary(data_mutations)
#colnames(RNA.data)
#colnames(patient.data)
#colnames(mutations.data)
```


filter data
```{r}
patient_df<-patient.data
patient_df$PATIENT_ID<-substr(patient_df$PATIENT_ID,9,12)

mutations_df<-mutations.data
mutations_df$Tumor_Sample_Barcode<-substr(mutations_df$Tumor_Sample_Barcode,9,12)

#make copy of RNA data frame without the first column
RNA_df <- RNA.data[,-1]

#rename columns to match patient id naming convention of other data sets
colnames(RNA_df)<-substr(colnames(RNA_df),9,12)

#find unique patients
unique_patients<-unique(patient_df$PATIENT_ID)
unique_mutations<-unique(mutations_df$Tumor_Sample_Barcode)
unique_RNA<-unique(colnames(RNA_df))
#find common patients
common_patients<-Reduce(intersect, list(unique_patients,unique_mutations,unique_RNA))

#patient data with patients in all three data sets
unq_patient_df<-patient_df[patient_df$PATIENT_ID %in% common_patients,]

#mutation data with patients in all three data sets
unq_mutations_df<-mutations_df[mutations_df$Tumor_Sample_Barcode %in% common_patients,]

#RNA data with patients in all three data sets
unq_RNA_ID<-RNA_df[, colnames(RNA_df)%in% common_patients]

#add back the first column (X) from the RNA data frame
RNA_df$X<-RNA.data$X[match(rownames(RNA_df), rownames(RNA.data))] 

#Take out censored patients

censored_patients <-  unq_patient_df %>%
  filter(PFS_STATUS == "0:CENSORED") %>%
  pull(PATIENT_ID)

unq_patient_df<-unq_patient_df[!unq_patient_df$PATIENT_ID %in% censored_patients,]

unq_mutations_df <-  unq_mutations_df[!unq_mutations_df$Tumor_Sample_Barcode %in% censored_patients,]

RNA_df <- RNA_df[, !colnames(RNA_df) %in% censored_patients]


unq_mutations_df$IMPACT <- as.character(unq_mutations_df$IMPACT)

#Take out Low impact mutations
filtered_mutations <- subset(unq_mutations_df, IMPACT != "LOW")


unique(filtered_mutations$IMPACT)

```
Summaries
```{r}
summary(unq_patient_df)
#summary(filtered_mutations)
#summary(unq_RNA_ID)

```





_______________________________________________________________________________________________________________________________________

Analysis:
1. Clinical Data
2. Mutation Data
3. Expression Data

_______________________________________________________________________________________________________________________________________







_______________________________________________________________________________________________________________________________________
Clinical Data:
1. Explore clinical data wrt the distribution based on various variable/attributes such as age, stage, survival, etc 
_______________________________________________________________________________________________________________________________________

Age Distribution
```{r}
ggplot(unq_patient_df, aes(x = AGE)) +
  geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Age Distribution", x = "Age", y = "Count") +
  theme_minimal()
```
cancer stage Distribution
```{r}
ggplot(unq_patient_df, aes(x = AGE, fill = OS_STATUS)) +
  geom_histogram(binwidth = 5, position = "dodge", alpha = 0.7) +
  labs(title = "Age Distribution by Overall Survival Status", x = "Age", y = "Count", fill = "OS Status") +
  theme_minimal()

```

Age vs Overall Survival (OS) Status
```{r}
ggplot(unq_patient_df, aes(x = AGE, fill = OS_STATUS)) +
  geom_histogram(binwidth = 5, position = "dodge", alpha = 0.7) +
  labs(title = "Age Distribution by Overall Survival Status", x = "Age", y = "Count", fill = "OS Status") +
  theme_minimal()
```
Age vs Progression-Free Survival (PFS) Status
```{r}
ggplot(unq_patient_df, aes(x = AGE, fill = PFS_STATUS)) +
  geom_histogram(binwidth = 5, position = "dodge", alpha = 0.7) +
  labs(title = "Age Distribution by Progression-Free Survival Status", x = "Age", y = "Count", fill = "PFS Status") +
  theme_minimal()
```
Age Distribution with Boxplot Grouped by Tumor Stage
```{r}
ggplot(unq_patient_df, aes(x = AJCC_PATHOLOGIC_TUMOR_STAGE, y = AGE, fill = AJCC_PATHOLOGIC_TUMOR_STAGE)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Age Distribution by Tumor Stage", x = "Tumor Stage", y = "Age") +
  theme_minimal() +
  theme(legend.position = "none")
```
Survival Distribution by Age
```{r}
ggplot(unq_patient_df, aes(x = AGE, fill = DSS_STATUS)) +
  geom_histogram(binwidth = 5, position = "stack", alpha = 0.7) +
  labs(title = "Age Distribution by Disease-Specific Survival Status", x = "Age", y = "Count", fill = "DSS Status") +
  theme_minimal()
```

Survival analysis
Prepare Data
```{r}
# Prepare survival data
unq_patient_df <- unq_patient_df %>%
  mutate(
    # Convert OS_STATUS to a logical deceased indicator
    deceased = ifelse(OS_STATUS == "1:DECEASED", TRUE, FALSE),
    # Ensure OS_MONTHS is numeric
    overall_survival = as.numeric(OS_MONTHS)
  )
```
Kaplan-Meier Analysis by Gender
```{r}
# Fit a survival model for gender
fit_gender <- survfit(Surv(overall_survival, deceased) ~ gender, data = clin_df)

# Kaplan-Meier plot for gender
ggsurvplot(fit_gender, data = clin_df, pval = TRUE, risk.table = TRUE, risk.table.col = "strata", risk.table.height = 0.3)
```
Kaplan-Meier Analysis by Tumor Stage
```{r}
# Simplify AJCC_PATHOLOGIC_TUMOR_STAGE by removing sub-stages
unq_patient_df <- unq_patient_df %>%
  mutate(tumor_stage = gsub("[abc]$", "", AJCC_PATHOLOGIC_TUMOR_STAGE))

# Fit survival model by tumor stage
fit_stage <- survfit(Surv(overall_survival, deceased) ~ tumor_stage, data = unq_patient_df)

# Plot Kaplan-Meier survival curves
ggsurvplot(fit_stage, 
           data = unq_patient_df, 
           pval = TRUE, 
           risk.table = TRUE, 
           risk.table.col = "strata", 
           risk.table.height = 0.3,
           title = "Survival by Tumor Stage")

```
Kaplan-Meier Analysis by Race
```{r}
# Group races into "white", "asian", "black", and "others"
unq_patient_df <- unq_patient_df %>%
  mutate(race_group = ifelse(RACE %in% c("white", "asian", "black or african american"), RACE, "others"))

# Fit survival model by race group
fit_race <- survfit(Surv(overall_survival, deceased) ~ race_group, data = unq_patient_df)

# Plot Kaplan-Meier survival curves
ggsurvplot(fit_race, 
           data = unq_patient_df, 
           pval = TRUE, 
           risk.table = TRUE, 
           risk.table.col = "strata", 
           risk.table.height = 0.3,
           title = "Survival by Race Group")

```
Kaplan-Meier Survival Analysis by Age Group
```{r}
# Create age groups
unq_patient_df <- unq_patient_df %>%
  mutate(age_group = case_when(
    AGE < 50 ~ "<50",
    AGE >= 50 & AGE < 65 ~ "50-65",
    AGE >= 65 ~ "65+"
  ))

# Fit survival model by age group
fit_age <- survfit(Surv(overall_survival, deceased) ~ age_group, data = unq_patient_df)

# Plot Kaplan-Meier survival curves
ggsurvplot(fit_age, 
           data = unq_patient_df, 
           pval = TRUE, 
           risk.table = TRUE, 
           risk.table.col = "strata", 
           risk.table.height = 0.3,
           title = "Survival by Age Group")

```









Mutation data:
1. Build a gene-patient matrix that contains mutation data. Within this matrix, "1" represents whether there is a mutation in a given gene and given patient and "0" represents no mutation. Note, when building this matrix, you can take into account the type of mutations (e.g., synonymous, non-synonymous, etc) 
2. Pick the top 20 or most frequently mutated genes from this matrix.  
3. Perform clustering on the resulting mutation matrix Perhaps try ward and ward.D2 linkage methods if you see narrow clusters.
4. Take the clusters of patients and do (a) DE analysis on all genes (not just top 500), (b) do pathway analysis on the DE genes that pass the adjusted p-value threshold (not just the top 20 genes) to see if specific pathways are hit, (c) see if outcome data between patient clusters is different, (d) see if any other clinical data is different when you compare patient clusters, (e) explore the correlation between the patient clusters that you have got from mutation and expression data - how much overlap do you see between the patient clusters?

1. gene-patient matrix that contains mutation data
```{r}
#str(data_mutations)

#matrix of genes (rows) and patients (columns)
gene_patient_matrix <- table(data_mutations$Hugo_Symbol, data_mutations$Tumor_Sample_Barcode)

#convert to binary matrix (1 for mutation, 0 for no mutation)
gene_patient_matrix <- as.matrix(gene_patient_matrix)
gene_patient_matrix[gene_patient_matrix > 1] <- 1  # Ensure binary representation

```
2. Pick the Top 20 Most Frequently Mutated Genes
```{r}
# Calculate the mutation frequency per gene
mutation_frequency <- rowSums(gene_patient_matrix)

# Sort genes by mutation frequency in descending order
sorted_genes <- sort(mutation_frequency, decreasing = TRUE)

# Select the top 20 most frequently mutated genes
top_genes <- names(sorted_genes[1:20])

# Subset the gene-patient matrix for the top 20 genes
top_gene_matrix <- gene_patient_matrix[top_genes, ]

#top_gene_matrix
```


3. Perform clustering on the resulting mutation matrix
```{r}
# Perform hierarchical clustering on the transposed matrix to cluster patients
hc_patients <- hclust(dist(t(top_gene_matrix)), method = "ward.D2")

# Plot the dendrogram for patient clustering
plot(hc_patients, main = "Hierarchical Clustering of Patients", xlab = "Patients", sub = "", cex = 0.8)

# Cut the dendrogram into clusters (e.g., 3 clusters)
patient_clusters <- cutree(hc_patients, k = 3)

# Create a data frame mapping patients to clusters
clustered_patients <- data.frame(
  Patient = colnames(top_gene_matrix),
  Cluster = patient_clusters,
  stringsAsFactors = FALSE
)

```
4a. Differential Expression (DE) Analysis
```{r}
# Ensure RNAseq_LIHC is numeric and handle missing values
if (!is.numeric(RNAseq_LIHC)) {
  RNAseq_LIHC <- as.matrix(RNAseq_LIHC)  # Convert to matrix if not already
  mode(RNAseq_LIHC) <- "numeric"         # Ensure numeric values
}
RNAseq_LIHC[is.na(RNAseq_LIHC)] <- 0     # Replace NA values with 0

# Match patient identifiers between RNAseq_LIHC and clustered_patients
common_patients <- intersect(colnames(RNAseq_LIHC), clustered_patients$Patient)
RNAseq_LIHC <- RNAseq_LIHC[, common_patients]  # Subset RNAseq_LIHC for matching patients
clustered_patients <- clustered_patients[clustered_patients$Patient %in% common_patients, ]
rownames(clustered_patients) <- clustered_patients$Patient  # Set rownames for DESeq2 compatibility

# Perform DESeq2 analysis
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = RNAseq_LIHC, colData = clustered_patients, design = ~ Cluster)
dds <- DESeq(dds)
res <- results(dds)

# Filter significant DE genes by adjusted p-value
de_genes <- rownames(res[which(res$padj < 0.05), ])

# Output a summary of DE results
summary(res)

# View top DE genes
head(de_genes)

```


Expression data:
1. Normalize expression data using DEseq2. This was explained and included in the lab document. 
2. Pick the top n (e.g., 500, 1000, ...) most variable genes. This could be done before step 1 or after step 1. 
3. Perform clustering on the resulting expression matrix. Perhaps try ward and ward.D2 linkage methods if you see narrow clusters.
4. Take the clusters of patients and do (a) DE analysis on all genes (not just top 500), (b) do pathway analysis on the DE genes that pass the adjusted p-value threshold (not just the top 20 genes) to see if specific pathways are hit, (c) see if outcome data between the patient clusters is different, (d) see if any other clinical data is different when you compare patient clusters, (e) see if patient clusters are enriched with any type of mutation data.   
```{r}

```


